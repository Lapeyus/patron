<!DOCTYPE html>
<html lang="es">

	<head>
	    <meta charset="UTF-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	    <!-- Prevent the browser from requesting /favicon.ico (avoids 404 noise). -->
	    <link rel="icon" href="data:,">
	    <title>Comunidad Patrón</title>
	    <style>
        :root {
            --primary: #222;
            --secondary: #717171;
            --accent: #e51d53;
            --bg: #fff;
            --card-bg: #fff;
            --border: #dddddd;
        }

        body {
            font-family: "Circular", -apple-system, BlinkMacSystemFont, Roboto, Helvetica Neue, sans-serif;
            background: #fff;
            margin: 0;
            display: flex;
            height: 100vh;
            color: var(--primary);
        }

        /* Sidebar */
        aside {
            width: 280px;
            background: #fff;
            border-right: 1px solid var(--border);
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
            z-index: 10;
            scrollbar-width: thin;
        }

	        aside h2 {
	            margin: 0;
	            font-size: 22px;
	            font-weight: 700;
	            color: #ff385c;
	        }

	        .lang-switch {
	            display: flex;
	            align-items: center;
	            justify-content: space-between;
	            gap: 10px;
	            padding: 6px 0 2px;
	        }

	        .lang-switch label {
	            font-size: 12px;
	            color: var(--secondary);
	            text-transform: uppercase;
	            letter-spacing: 0.5px;
	        }

	        .lang-switch select {
	            flex: 1;
	            padding: 8px 10px;
	            border: 1px solid var(--border);
	            border-radius: 10px;
	            background: #fff;
	            color: var(--primary);
	            font-weight: 600;
	            cursor: pointer;
	        }

        .filter-group h3 {
            margin: 0 0 12px;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            color: var(--secondary);
            margin-bottom: 8px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .filter-group label:hover {
            color: var(--primary);
        }

        .filter-group input {
            width: 16px;
            height: 16px;
            accent-color: #222;
            cursor: pointer;
        }

        /* Main Grid */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px 40px;
            overflow: hidden;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 16px;
        }

        .controls input {
            padding: 12px 16px;
            border-radius: 40px;
            border: 1px solid var(--border);
            width: 300px;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.2s;
        }

        .controls input:focus {
            outline: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #222;
        }

        .controls select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
            overflow-y: auto;
            padding-right: 10px;
            padding-bottom: 40px;
        }

        /* Modern Card */
        .card {
            background: transparent;
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            cursor: pointer;
        }

        .card-img-container {
            position: relative;
            aspect-ratio: 3/4;
            border-radius: 12px;
            overflow: hidden;
            background: #f7f7f7;
            margin-bottom: 10px;
        }

        .card-img-container img.main-img,
        .card-img-container video.main-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .card:hover .card-img-container img.main-img,
        .card:hover .card-img-container video.main-img {
            transform: scale(1.05);
        }

        .card-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .name {
            font-size: 16px;
            font-weight: 600;
            color: #222;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .age {
            font-size: 14px;
            color: #444;
        }

        .location {
            font-size: 14px;
            color: #717171;
        }

        .price {
            font-size: 14px;
            color: #222;
            font-weight: 600;
            margin-top: 4px;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .pill {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            background: #f1f1f1;
            color: #444;
        }

        .media-counter {
            position: absolute;
            left: 8px;
            bottom: 8px;
            display: flex;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(0, 0, 0, 0.78);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.35);
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            line-height: 1;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
            -webkit-backdrop-filter: blur(6px);
            backdrop-filter: blur(6px);
            pointer-events: none;
        }

        .media-counter .mc-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .media-counter .mc-icon {
            width: 14px;
            height: 14px;
            flex: 0 0 auto;
            display: inline-block;
        }

        /* Lightbox Enhanced -> Profile Modal */
        #lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        #lightbox.active {
            display: flex;
        }

        .lb-content {
            display: flex;
            width: 90%;
            height: 90%;
            max-width: 1100px;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .lb-media {
            flex: 1.5;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .lb-main-media {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lb-main-media img,
        .lb-main-media video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .lb-main-media video {
            background: #000;
        }

        .lb-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 44px;
            height: 44px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.55);
            background: rgba(0, 0, 0, 0.45);
            color: #fff;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 6;
            font-size: 24px;
            line-height: 1;
            padding: 0;
            user-select: none;
            backdrop-filter: blur(6px);
        }

        .lb-nav:hover {
            background: rgba(0, 0, 0, 0.6);
        }

        .lb-nav:active {
            transform: translateY(-50%) scale(0.97);
        }

        .lb-nav:focus-visible {
            outline: 2px solid rgba(255, 255, 255, 0.9);
            outline-offset: 2px;
        }

        .lb-nav-left {
            left: 16px;
        }

        .lb-nav-right {
            right: 16px;
        }

        .lb-details {
            flex: 1;
            min-width: 350px;
            background: #fff;
            padding: 32px;
            overflow-y: auto;
            position: relative;
        }

        .lb-close {
            position: absolute;
            top: 20px;
            left: 20px;
            /* On the image side? No, maybe top right of modal */
            z-index: 10;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            width: 40px;
            text-align: center;
            border-radius: 50%;
            line-height: 40px;
            cursor: pointer;
            font-size: 24px;
        }

        /* Put close button on top right of WHOLE modal */
        #lb-close-global {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            background: #f0f0f0;
            color: #333;
            border-radius: 50%;
            text-align: center;
            line-height: 36px;
            font-size: 24px;
            cursor: pointer;
            z-index: 20;
        }

        #lb-close-global:hover {
            background: #e0e0e0;
        }

        .lb-header {
            margin-bottom: 24px;
            border-bottom: 1px solid #eee;
            padding-bottom: 16px;
        }

        .lb-header h1 {
            margin: 0;
            font-size: 26px;
        }

        .lb-header p {
            margin: 4px 0 0;
            color: #717171;
        }

        .lb-section {
            margin-bottom: 24px;
        }

        .lb-section h3 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            color: #222;
            margin-bottom: 12px;
        }

        .lb-attr-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .lb-attr {
            font-size: 14px;
        }

        .lb-attr span {
            display: block;
        }

        .lb-attr .k {
            color: #717171;
            font-size: 12px;
        }

        .lb-attr .v {
            color: #222;
            font-weight: 500;
        }

        .lb-price-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f9f9f9;
            font-size: 14px;
        }

        .lb-price-item .amt {
            font-weight: 600;
        }

        .price-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .price-table th,
        .price-table td {
            text-align: left;
            padding: 8px 4px;
            border-bottom: 1px solid #f0f0f0;
        }

        .price-table th {
            font-weight: 600;
            color: #555;
        }

        .price-table td:last-child {
            text-align: right;
            font-weight: 600;
        }

        /* Key/value tables inside extraction (e.g., other_attributes) should not right-align values. */
        .kv-table td:last-child {
            text-align: left;
            font-weight: 500;
        }

        .lb-thumbs {
            position: absolute;
            bottom: 16px;
            left: 16px;
            right: 16px;
            transform: none;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-wrap: nowrap;
            gap: 8px;
            padding: 8px 10px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 16px;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            z-index: 5;
        }

        .lb-thumbs::-webkit-scrollbar {
            height: 8px;
        }

        .lb-thumbs::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 999px;
        }

        .lb-thumbs::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.35);
            border-radius: 999px;
        }

        .lb-thumb {
            width: 40px;
            height: 40px;
            flex: 0 0 auto;
            border-radius: 4px;
            object-fit: cover;
            cursor: pointer;
            opacity: 0.7;
            border: 2px solid transparent;
        }

        .lb-thumb video,
        .lb-thumb img {
            width: 100%;
            height: 100%;
            border-radius: 4px;
            object-fit: cover;
        }

        .lb-thumb.active {
            opacity: 1;
            border-color: white;
        }

        .cta-btn {
            display: block;
            background: #25D366;
            color: white;
            text-align: center;
            padding: 14px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 10px;
            font-size: 15px;
        }

        /* Legal disclaimer modal (shown once on first visit) */
        #disclaimer-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            z-index: 2000;
            padding: 24px;
        }

        #disclaimer-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .disclaimer-modal {
            width: min(720px, 100%);
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
            overflow: hidden;
        }

        .disclaimer-header {
            padding: 18px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .disclaimer-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 0.4px;
            text-transform: uppercase;
            color: #222;
        }

        .disclaimer-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #e5e5e5;
            background: #fafafa;
            cursor: pointer;
            font-size: 18px;
            line-height: 30px;
            text-align: center;
            color: #333;
        }

        .disclaimer-body {
            padding: 18px 20px;
            max-height: min(65vh, 520px);
            overflow: auto;
            color: #333;
            font-size: 14px;
            line-height: 1.5;
        }

        .disclaimer-body p {
            margin: 0 0 12px;
        }

        .disclaimer-footer {
            padding: 14px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .disclaimer-btn {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
            font-weight: 600;
            color: #222;
        }

        .disclaimer-btn.primary {
            border-color: #222;
            background: #222;
            color: #fff;
        }

        /* Password gate (client-side; not true security without server-side auth). */
        #auth-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.72);
            z-index: 2500;
            padding: 24px;
        }

        #auth-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-modal {
            width: min(520px, 100%);
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
            overflow: hidden;
        }

        .auth-header {
            padding: 18px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .auth-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 0.4px;
            text-transform: uppercase;
            color: #222;
        }

        .auth-header .lang-switch {
            padding: 0;
            gap: 8px;
            justify-content: flex-end;
        }

        .auth-header .lang-switch label {
            font-size: 11px;
        }

        .auth-body {
            padding: 18px 20px;
            color: #333;
            font-size: 14px;
            line-height: 1.5;
        }

        .auth-body p {
            margin: 0 0 12px;
        }

        .auth-input {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #ddd;
            font-size: 14px;
            box-sizing: border-box;
        }

        .auth-input:focus {
            outline: none;
            border-color: #222;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .auth-row {
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .auth-remember {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #555;
            cursor: pointer;
            user-select: none;
        }

        .auth-remember input {
            width: 16px;
            height: 16px;
            accent-color: #222;
            cursor: pointer;
        }

        .auth-error {
            margin-top: 12px;
            color: #c81d4d;
            font-size: 13px;
            display: none;
        }

        .auth-footer {
            padding: 14px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .auth-btn {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
            font-weight: 600;
            color: #222;
        }

        .auth-btn.primary {
            border-color: #222;
            background: #222;
            color: #fff;
        }

        @media (max-width: 800px) {
            .lb-content {
                flex-direction: column;
                overflow: hidden;
                height: 100%;
                width: 100%;
                border-radius: 0;
            }

            .lb-media {
                height: 40vh;
                flex: none;
            }

            .lb-details {
                flex: 1;
            }
        }
    </style>
</head>

<body>
	    <aside id="filters">
	        <h2>Comunidad Patrón</h2>
	        <!-- Filters -->
	    </aside>

    <main>
	        <div class="controls">
	            <input type="text" id="searchInput" placeholder="Buscar..." oninput="render()">
	            <select id="sortSelect" onchange="render()">
	                <option value="newest">Más recientes</option>
	                <option value="price_asc">Precio: menor a mayor</option>
	                <option value="price_desc">Precio: mayor a menor</option>
	            </select>
	            <div id="stats" style="padding:10px; color:#666;"></div>
	        </div>
        <div class="grid" id="grid"></div>
    </main>

    <!-- Modal -->
	    <div id="lightbox" onclick="if(event.target===this) closeProfile()">
	        <div class="lb-content">
	            <div id="lb-close-global" onclick="closeProfile()">&times;</div>
	            <div class="lb-media">
	                <div id="lb-main-media" class="lb-main-media"></div>
                    <button id="lb-nav-left" class="lb-nav lb-nav-left" type="button" aria-label="Mover a la izquierda" onclick="cycleImage(-1)">‹</button>
                    <button id="lb-nav-right" class="lb-nav lb-nav-right" type="button" aria-label="Mover a la derecha" onclick="cycleImage(1)">›</button>
	                <div id="lb-thumbs" class="lb-thumbs"></div>
	            </div>
            <div class="lb-details" id="lb-details-content">
                <!-- details -->
            </div>
        </div>
    </div>

    <!-- Password gate (UI only) -->
    <div id="auth-overlay" role="dialog" aria-modal="true" aria-label="Acceso">
        <div class="auth-modal" onclick="event.stopPropagation()">
            <div class="auth-header">
                <h3 id="auth-title">Acceso</h3>
                <div class="lang-switch">
                    <label for="auth-lang-select" id="auth-lang-label">Idioma</label>
                    <select id="auth-lang-select">
                        <option value="es">Español</option>
                        <option value="en">Inglés</option>
                    </select>
                </div>
            </div>
            <div class="auth-body">
                <p id="auth-prompt">Ingresa la contraseña para ver el contenido.</p>
                <input id="auth-password" class="auth-input" type="password" placeholder="Contraseña" autocomplete="current-password">
                <div class="auth-row">
                    <label class="auth-remember">
                        <input id="auth-remember" type="checkbox">
                        <span id="auth-remember-label">Recordar en este dispositivo</span>
                    </label>
                </div>
                <div class="auth-error" id="auth-error" role="alert"></div>
            </div>
            <div class="auth-footer">
                <button class="auth-btn primary" id="auth-submit" type="button">Entrar</button>
            </div>
        </div>
    </div>

    <!-- Legal disclaimer (popup on first visit) -->
    <div id="disclaimer-overlay" role="dialog" aria-modal="true" aria-label="Aviso legal">
        <div class="disclaimer-modal" onclick="event.stopPropagation()">
	            <div class="disclaimer-header">
	                <h3 id="disclaimer-title">Aviso legal</h3>
	                <button class="disclaimer-close" id="disclaimer-close" type="button" aria-label="Cerrar">&times;</button>
	            </div>
	            <div class="disclaimer-body" id="disclaimer-body">
	                <p><strong>INFORMACIÓN EMANADA DIRECTAMENTE DEL CONTACTO.</strong></p>
	                <p>El responsable de esta base de datos, NO TIENE INJERENCIA ALGUNA en la fijación de dichos montos y NO PARTICIPA, de dichos honorarios, en forma alguna.</p>
	                <p>CLUB PATRÓN se limita a proporcionarle el contacto.</p>
	            </div>
            <div class="disclaimer-footer">
                <button class="disclaimer-btn" id="disclaimer-later" type="button">Cerrar</button>
                <button class="disclaimer-btn primary" id="disclaimer-accept" type="button">Entendido</button>
            </div>
        </div>
    </div>

    <script>
	        const DATA_SOURCES = [
	            'consolidated_profiles_enriched.json',
	            'catalog.json'
	        ];
	        const LANG_STORAGE_KEY = "patron_lang_v1";
	        let currentLang = "es";
	        try {
	            const storedLang = localStorage.getItem(LANG_STORAGE_KEY);
	            if (storedLang) currentLang = storedLang;
	        } catch (_) { /* ignore */ }
	        if (!["es", "en"].includes(currentLang)) currentLang = "es";

	        const I18N = {
	            es: {
	                app_title: "Comunidad Patrón",
	                language_label: "Idioma",
	                language_es: "Español",
	                language_en: "Inglés",
	                search_placeholder: "Buscar...",
	                sort_newest: "Más recientes",
	                sort_price_asc: "Precio: menor a mayor",
	                sort_price_desc: "Precio: mayor a menor",
	                stats_found: (n) => `${n} encontrados`,
	                unknown: "Desconocido",
	                yes: "Sí",
	                no: "No",
	                years_old: (n) => `${n} años`,
	                years_short: (n) => `${n} años`,
	                nav_left: "Mover a la izquierda",
	                nav_right: "Mover a la derecha",
	                photos: "Fotos",
	                videos: "Videos",
	                filters_provincia: "Ubicación",
	                filters_edad: "Edad",
	                filters_categories: "Categorías",
	                category_new: "Solo nuevos ingresos",
	                category_noexp: "Solo sin experiencia",
	                category_courtesy: "Solo cortesía",
	                category_newmedia: "Solo nuevas fotos/videos",
	                section_extraction: "Extracción",
	                section_attributes: "Atributos",
	                section_rates: "Tarifas",
	                section_services: "Servicios",
	                section_availability: "Disponibilidad",
	                section_tags: "Etiquetas",
	                section_contact: "Contacto",
	                table_service: "Servicio",
	                table_amount: "Monto",
	                call: "Llamar",
	                label_whatsapp: "WhatsApp",
	                label_phone: "Tel",
	                label_email: "Email",
	                label_social: "Social",
	                label_contact: "Contacto",
	                disclaimer_title: "Aviso legal",
	                disclaimer_close_aria: "Cerrar",
	                disclaimer_body_strong: "INFORMACIÓN EMANADA DIRECTAMENTE DEL CONTACTO.",
	                disclaimer_body_p2:
	                    "El responsable de esta base de datos, NO TIENE INJERENCIA ALGUNA en la fijación de dichos montos y NO PARTICIPA, de dichos honorarios, en forma alguna.",
	                disclaimer_body_p3: "CLUB PATRÓN se limita a proporcionarle el contacto.",
	                disclaimer_btn_close: "Cerrar",
	                disclaimer_btn_accept: "Entendido",
	                auth_title: "Acceso",
	                auth_prompt: "Ingresa la contraseña para ver el contenido.",
	                auth_password_placeholder: "Contraseña",
	                auth_remember: "Recordar en este dispositivo",
	                auth_submit: "Entrar",
	                auth_error_required: "Ingresa una contraseña.",
	                auth_error_incorrect: "Contraseña incorrecta.",
	            },
	            en: {
	                app_title: "Patrón Community",
	                language_label: "Language",
	                language_es: "Spanish",
	                language_en: "English",
	                search_placeholder: "Search...",
	                sort_newest: "Newest",
	                sort_price_asc: "Price: low to high",
	                sort_price_desc: "Price: high to low",
	                stats_found: (n) => `${n} found`,
	                unknown: "Unknown",
	                yes: "Yes",
	                no: "No",
	                years_old: (n) => `${n} years old`,
	                years_short: (n) => `${n} yrs`,
	                nav_left: "Move left",
	                nav_right: "Move right",
	                photos: "Photos",
	                videos: "Videos",
	                filters_provincia: "Location",
	                filters_edad: "Age",
	                filters_categories: "Categories",
	                category_new: "Only new entries",
	                category_noexp: "Only no experience",
	                category_courtesy: "Only courtesy profiles",
	                category_newmedia: "Only new photos/videos",
	                section_extraction: "Extraction",
	                section_attributes: "Attributes",
	                section_rates: "Rates",
	                section_services: "Services",
	                section_availability: "Availability",
	                section_tags: "Tags",
	                section_contact: "Contact",
	                table_service: "Service",
	                table_amount: "Amount",
	                call: "Call",
	                label_whatsapp: "WhatsApp",
	                label_phone: "Phone",
	                label_email: "Email",
	                label_social: "Social",
	                label_contact: "Contact",
	                disclaimer_title: "Legal notice",
	                disclaimer_close_aria: "Close",
	                disclaimer_body_strong: "INFORMATION PROVIDED DIRECTLY BY THE CONTACT.",
	                disclaimer_body_p2:
	                    "The owner of this database has no involvement in setting these amounts and does not participate in these fees in any way.",
	                disclaimer_body_p3: "CLUB PATRÓN only provides the contact information.",
	                disclaimer_btn_close: "Close",
	                disclaimer_btn_accept: "I understand",
	                auth_title: "Access",
	                auth_prompt: "Enter the password to view the content.",
	                auth_password_placeholder: "Password",
	                auth_remember: "Remember on this device",
	                auth_submit: "Enter",
	                auth_error_required: "Please enter a password.",
	                auth_error_incorrect: "Incorrect password.",
	            }
	        };

	        function t(key, ...args) {
	            const dict = I18N[currentLang] || I18N.es;
	            const fallback = I18N.es[key];
	            const value = dict[key] ?? fallback ?? key;
	            return typeof value === "function" ? value(...args) : value;
	        }

	        const FIELD_LABELS = {
	            name: { es: "Nombre", en: "Name" },
		            age: { es: "Edad", en: "Age" },
		            height: { es: "Estatura", en: "Height" },
		            weight: { es: "Peso", en: "Weight" },
		            measurements: { es: "Medidas", en: "Measurements" },
		            hair_color: { es: "Color de cabello", en: "Hair color" },
	            eye_color: { es: "Color de ojos", en: "Eye color" },
	            location: { es: "Ubicación", en: "Location" },
	            availability: { es: "Disponibilidad", en: "Availability" },
	            contact: { es: "Contacto", en: "Contact" },
	            prices: { es: "Tarifas", en: "Rates" },
	            implants: { es: "Implantes", en: "Implants" },
	            uber: { es: "Uber", en: "Uber" },
	            cosmetic_surgeries: { es: "Cirugías estéticas", en: "Cosmetic surgeries" },
	            other_attributes: { es: "Otros atributos", en: "Other attributes" },
	        };

	        function fieldLabel(key = "") {
	            const entry = FIELD_LABELS[key];
	            if (entry) return entry[currentLang] || entry.es || key;
	            return key.toString().replace(/_/g, " ");
	        }

	        const PRICE_SLOT_DISPLAY = {
	            one_hour: { es: { label: "1 hora", short: "1h" }, en: { label: "1 hour", short: "1h" } },
	            two_hours: { es: { label: "2 horas", short: "2h" }, en: { label: "2 hours", short: "2h" } },
	            three_hours: { es: { label: "3 horas", short: "3h" }, en: { label: "3 hours", short: "3h" } },
	            overnight: { es: { label: "Toda la noche", short: "Noche" }, en: { label: "Overnight", short: "Night" } },
	        };

	        function priceSlotLabel(key = "") {
	            const entry = PRICE_SLOT_DISPLAY[key];
	            if (entry) return (entry[currentLang] || entry.es).label;
	            return key.toString().replace(/_/g, " ");
	        }

	        function priceSlotShort(key = "") {
	            const entry = PRICE_SLOT_DISPLAY[key];
	            if (entry) return (entry[currentLang] || entry.es).short;
	            return key.toString();
	        }

	        function applyStaticTranslations() {
	            document.documentElement.lang = currentLang;
	            document.title = t("app_title");
	            const search = document.getElementById("searchInput");
	            if (search) search.placeholder = t("search_placeholder");
	            const sort = document.getElementById("sortSelect");
	            if (sort) {
	                const optNewest = sort.querySelector('option[value="newest"]');
	                const optAsc = sort.querySelector('option[value="price_asc"]');
	                const optDesc = sort.querySelector('option[value="price_desc"]');
	                if (optNewest) optNewest.textContent = t("sort_newest");
	                if (optAsc) optAsc.textContent = t("sort_price_asc");
	                if (optDesc) optDesc.textContent = t("sort_price_desc");
	            }

	            const navLeft = document.getElementById("lb-nav-left");
	            const navRight = document.getElementById("lb-nav-right");
	            if (navLeft) navLeft.setAttribute("aria-label", t("nav_left"));
	            if (navRight) navRight.setAttribute("aria-label", t("nav_right"));

	            const authTitle = document.getElementById("auth-title");
	            if (authTitle) authTitle.textContent = t("auth_title");
	            const authOverlay = document.getElementById("auth-overlay");
	            if (authOverlay) authOverlay.setAttribute("aria-label", t("auth_title"));
	            const authPrompt = document.getElementById("auth-prompt");
	            if (authPrompt) authPrompt.textContent = t("auth_prompt");
	            const authPassword = document.getElementById("auth-password");
	            if (authPassword) authPassword.placeholder = t("auth_password_placeholder");
	            const authRememberLabel = document.getElementById("auth-remember-label");
	            if (authRememberLabel) authRememberLabel.textContent = t("auth_remember");
	            const authSubmit = document.getElementById("auth-submit");
	            if (authSubmit) authSubmit.textContent = t("auth_submit");
	            const authLangLabel = document.getElementById("auth-lang-label");
	            if (authLangLabel) authLangLabel.textContent = t("language_label");
	            const authLangSelect = document.getElementById("auth-lang-select");
	            if (authLangSelect) {
	                const optEs = authLangSelect.querySelector('option[value="es"]');
	                const optEn = authLangSelect.querySelector('option[value="en"]');
	                if (optEs) optEs.textContent = t("language_es");
	                if (optEn) optEn.textContent = t("language_en");
	                authLangSelect.value = currentLang;
	            }

	            const disclaimerTitle = document.getElementById("disclaimer-title");
	            if (disclaimerTitle) disclaimerTitle.textContent = t("disclaimer_title");
	            const disclaimerOverlay = document.getElementById("disclaimer-overlay");
	            if (disclaimerOverlay) disclaimerOverlay.setAttribute("aria-label", t("disclaimer_title"));
	            const disclaimerBody = document.getElementById("disclaimer-body");
	            if (disclaimerBody) {
	                disclaimerBody.innerHTML = `
	                    <p><strong>${t("disclaimer_body_strong")}</strong></p>
	                    <p>${t("disclaimer_body_p2")}</p>
	                    <p>${t("disclaimer_body_p3")}</p>
	                `.trim();
	            }
	            const disclaimerClose = document.getElementById("disclaimer-close");
	            if (disclaimerClose) disclaimerClose.setAttribute("aria-label", t("disclaimer_close_aria"));
	            const disclaimerLater = document.getElementById("disclaimer-later");
	            if (disclaimerLater) disclaimerLater.textContent = t("disclaimer_btn_close");
	            const disclaimerAccept = document.getElementById("disclaimer-accept");
	            if (disclaimerAccept) disclaimerAccept.textContent = t("disclaimer_btn_accept");

	            const langSelect = document.getElementById("langSelect");
	            if (langSelect) langSelect.value = currentLang;
	        }

	        function setLanguage(lang) {
	            if (!I18N[lang]) return;
	            if (lang === currentLang) return;
	            currentLang = lang;
	            try { localStorage.setItem(LANG_STORAGE_KEY, currentLang); } catch (_) { /* ignore */ }
	            applyStaticTranslations();
	            buildFilters({ preserveActive: true });
	            render();
	            const lightbox = document.getElementById("lightbox");
	            if (lightbox?.classList.contains("active") && currentItemIndex >= 0) {
	                const idx = currentItemIndex;
	                const mediaIdx = currentImageIndex;
	                window.openProfile?.(idx);
	                currentImageIndex = mediaIdx;
	                updateLightboxImage();
	            }
	        }

	        const PRICE_SLOT_LABELS = {
	            one_hour: { label: "1 hora", canonical: "1 hora" },
	            two_hours: { label: "2 horas", canonical: "2 horas" },
	            three_hours: { label: "3 horas", canonical: "3 horas" },
	            overnight: { label: "Toda la noche", canonical: "Toda la noche" },
	        };

	        let catalog = [];
	        const PROVINCIA_ROOT_FOLDER = "10 - Perfiles - por provincia";
	        const EDAD_FOLDERS = [
	            "7 - Perfiles - 18 - 19 - 20 años",
	            "8 - Perfiles - 21- 30 años",
	            "9 - Perfiles - 31 - 40 años",
	        ];
	        const EDAD_LABELS = {
	            "7 - Perfiles - 18 - 19 - 20 años": { es: "18 - 20 años", en: "18 - 20 years" },
	            "8 - Perfiles - 21- 30 años": { es: "21- 30 años", en: "21- 30 years" },
	            "9 - Perfiles - 31 - 40 años": { es: "31 - 40 años", en: "31 - 40 years" },
	        };
	        const NUEVOS_INGRESOS_FOLDER = "6 - Perfiles recientemente incorporados";
	        const SIN_EXPERIENCIA_FOLDER = "5 - Perfiles sin experiencia recien ingresados";
	        const CORTESIA_FOLDER = "12 - Perfiles - cortesía";
	        const NUEVAS_FOTOS_VIDEOS_FOLDER = "11 - Perfiles con nuevas fotos - videos";

	        let filters = { provincia: new Set(), edad: new Set(), nuevos_ingresos: new Set(), sin_experiencia: new Set(), cortesia: new Set(), nuevas_fotos_videos: new Set() };
	        let activeFilters = { provincia: new Set(), edad: new Set(), nuevos_ingresos: new Set(), sin_experiencia: new Set(), cortesia: new Set(), nuevas_fotos_videos: new Set() };

            const DISCLAIMER_STORAGE_KEY = "patron_disclaimer_ack_v1";
            const AUTH_LOCAL_KEY = "patron_auth_ok_v1";
            const AUTH_SESSION_KEY = "patron_auth_ok_session_v1";
            // SHA-256 base64 of the password. Default password is: "patron"
            const AUTH_SHA256_B64 = "bnU6awo3zRAyyZG6FnzuWW25rcozFi6p5IoLqGxNrtM=";
            let appStarted = false;

            function isAuthed() {
                try {
                    if (sessionStorage.getItem(AUTH_SESSION_KEY) === "1") return true;
                } catch (_) { /* ignore */ }
                try {
                    if (localStorage.getItem(AUTH_LOCAL_KEY) === "1") return true;
                } catch (_) { /* ignore */ }
                return false;
            }

            function showAuthOverlay() {
                const overlay = document.getElementById("auth-overlay");
                if (!overlay) return;
                overlay.classList.add("active");
                setTimeout(() => document.getElementById("auth-password")?.focus(), 0);
            }

            function hideAuthOverlay() {
                const overlay = document.getElementById("auth-overlay");
                if (!overlay) return;
                overlay.classList.remove("active");
            }

            function showAuthError(message) {
                const err = document.getElementById("auth-error");
                if (!err) return;
                err.textContent = message || "";
                err.style.display = message ? "block" : "none";
            }

            async function sha256Base64(text) {
                if (!window.crypto?.subtle) {
                    throw new Error("WebCrypto unavailable (use https or http://localhost).");
                }
                const data = new TextEncoder().encode(text);
                const digest = await crypto.subtle.digest("SHA-256", data);
                const bytes = new Uint8Array(digest);
                let binary = "";
                for (const b of bytes) binary += String.fromCharCode(b);
                return btoa(binary);
            }

            async function attemptAuth() {
                const input = document.getElementById("auth-password");
                const remember = document.getElementById("auth-remember");
                const password = (input?.value || "").trim();
                if (!password) {
                    showAuthError(t("auth_error_required"));
                    input?.focus();
                    return;
                }
                let hashed = "";
                try {
                    hashed = await sha256Base64(password);
                } catch (err) {
                    showAuthError(err?.message || String(err));
                    return;
                }
                if (hashed !== AUTH_SHA256_B64) {
                    showAuthError(t("auth_error_incorrect"));
                    input?.focus();
                    return;
                }

                showAuthError("");
                if (input) input.value = "";
                try { sessionStorage.setItem(AUTH_SESSION_KEY, "1"); } catch (_) { /* ignore */ }
                try {
                    if (remember?.checked) localStorage.setItem(AUTH_LOCAL_KEY, "1");
                    else localStorage.removeItem(AUTH_LOCAL_KEY);
                } catch (_) { /* ignore */ }
                hideAuthOverlay();
                startAppOnce();
            }

            function setupAuth() {
                const submit = document.getElementById("auth-submit");
                if (submit) submit.addEventListener("click", () => attemptAuth());
                const input = document.getElementById("auth-password");
                if (input) {
                    input.addEventListener("keydown", (e) => {
                        if (e.key === "Enter") {
                            e.preventDefault();
                            attemptAuth();
                        }
                    });
                    input.addEventListener("input", () => showAuthError(""));
                }
                const langSelect = document.getElementById("auth-lang-select");
                if (langSelect) {
                    langSelect.value = currentLang;
                    langSelect.addEventListener("change", (e) => setLanguage(e.target.value));
                }
            }

            function showAuthIfNeeded() {
                if (isAuthed()) return false;
                showAuthOverlay();
                return true;
            }

            function startAppOnce() {
                if (appStarted) return;
                appStarted = true;
                showDisclaimerIfNeeded();
                loadData();
            }

            function hideDisclaimer(remember = false) {
                const overlay = document.getElementById("disclaimer-overlay");
                if (!overlay) return;
                if (remember) {
                    try { localStorage.setItem(DISCLAIMER_STORAGE_KEY, "1"); } catch (_) { /* ignore */ }
                }
                overlay.classList.remove("active");
            }

            function showDisclaimerIfNeeded() {
                const overlay = document.getElementById("disclaimer-overlay");
                if (!overlay) return;
                try {
                    if (localStorage.getItem(DISCLAIMER_STORAGE_KEY) === "1") return;
                } catch (_) { /* ignore */ }
                overlay.classList.add("active");
            }

	        async function loadData() {
	            let data = null;
	            for (const url of DATA_SOURCES) {
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
                    data = await res.json();
                    break;
                } catch (e) {
                    console.warn(`Unable to load ${url}:`, e.message || e);
                }
            }
            if (!data) {
                console.error("No catalog data available.");
                return;
            }
            catalog = Array.isArray(data) ? data : Array.isArray(data.profiles) ? data.profiles : [];
            catalog.forEach(hydrateItem);
            buildFilters();
            render();
        }

	        function hydrateItem(item) {
	            if (!item || item.__hydrated) return;
	            const structured = item.structured_data || item.merged_structured_data || {};
	            item.structured_data = structured;
	            const extraction = item.extraction || {};
            const metadata = item.merged_metadata || item.metadata || {};
            const rawResponses = item.raw_responses || (item.raw_response ? [item.raw_response] : []);
            if (!structured.raw_text && rawResponses.length) {
                structured.raw_text = rawResponses.join('\n\n');
            }
            structured.name = structured.name || extraction.name || item.profile || t('unknown');
            if (structured.age == null && extraction.age != null) structured.age = extraction.age;
            structured.location = structured.location || extraction.location || guessLocationFromMetadata(metadata);
            structured.availability = structured.availability || extraction.availability || '';
            structured.attributes = structured.attributes || {};
            ['height', 'weight', 'hair_color', 'eye_color', 'implants', 'measurements', 'uber', 'cosmetic_surgeries'].forEach(key => {
                if (!structured.attributes[key] && extraction[key] !== undefined && extraction[key] !== null) {
                    structured.attributes[key] = extraction[key];
                }
            });
            if (extraction.other_attributes && typeof extraction.other_attributes === 'object') {
                Object.entries(extraction.other_attributes).forEach(([key, value]) => {
                    if (structured.attributes[key] == null && value != null && value !== '') {
                        structured.attributes[key] = value;
                    }
                });
            }
            structured.contact = structured.contact || {};
            mergeContact(structured.contact, extraction.contact);
            if (!structured.services && extraction.services) structured.services = extraction.services;

            if (!structured.standard_prices) {
                structured.standard_prices = { one_hour: null, two_hours: null, three_hours: null, overnight: null };
            }
            structured.prices = Array.isArray(structured.prices) ? structured.prices.slice() : [];
            structured.prices.forEach(entry => {
                if (!entry) return;
                entry.canonical = entry.canonical || canonicalForDuration(entry.duration);
                if (entry.amount == null && entry.display) {
                    const info = parsePriceInfo(entry.display);
                    if (info && info.amount != null) {
                        entry.amount = info.amount;
                        entry.currency = entry.currency || info.currency;
                    }
                }
            });

            if (extraction.prices) {
                for (const [slot, value] of Object.entries(extraction.prices)) {
                    if (!value) continue;
                    const labelDef = PRICE_SLOT_LABELS[slot] || { label: slot.replace(/_/g, ' '), canonical: slot };
                    const info = parsePriceInfo(value) || {};
                    if (structured.standard_prices[slot] == null) {
                        structured.standard_prices[slot] = {
                            amount: info.amount ?? null,
                            currency: info.currency || null,
                            display: info.display || (typeof value === 'string' ? value : null),
                        };
                    }
                    structured.prices.push({
                        duration: labelDef.label,
                        amount: info.amount ?? null,
                        currency: info.currency || detectCurrencyFromString(info.display || value),
                        display: info.display || (typeof value === 'string' ? value : null),
                        canonical: labelDef.canonical,
                    });
                }
            }

	            item.metadata_tags = buildMetadataTags(metadata);
	            item.all_metadata = metadata;
	            item.folder_filters = deriveFolderFilters(item);
	            item.search_blob = buildSearchBlob(item);
	            if (!Array.isArray(item.media)) {
	                item.media = Array.isArray(item.images) ? item.images.slice() : (Array.isArray(item.media) ? item.media : []);
	            }
	            item.__hydrated = true;
	        }

        function hasMeaningfulExtraction(extraction = {}) {
            return Object.entries(extraction).some(([key, value]) => {
                if (value == null) return false;
                if (typeof value === 'object') {
                    if (Array.isArray(value)) return value.length > 0;
                    return Object.keys(value).length > 0;
                }
                if (typeof value === 'boolean') return true;
                const text = value.toString().trim();
                return text.length > 0;
            });
        }

        function getDisplayData(item) {
            const structured = item.structured_data || {};
            const extraction = item.extraction || {};
            if (hasMeaningfulExtraction(extraction)) {
                return { ...structured, ...extraction };
            }
            return structured;
        }

	        function formatFieldValue(value) {
	            if (value === null || value === undefined) return "—";
	            if (typeof value === "boolean") return value ? t("yes") : t("no");
	            if (typeof value === "number") return value.toString();
	            if (typeof value === "string") {
	                const trimmed = value.trim();
	                return trimmed ? trimmed : "—";
	            }
            if (typeof value === "object") {
                const keys = Object.keys(value);
                if (!keys.length) return "{}";
                return JSON.stringify(value, null, 2);
            }
            return String(value);
        }

        function escapeHtml(text) {
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/\"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

	        function renderExtractionSection(extraction) {
	            const ex = extraction || {};
	            const prices = (ex.prices && typeof ex.prices === "object") ? ex.prices : {};
	            const orderedKeys = [
                "name",
                "age",
                "height",
                "weight",
                "hair_color",
                "eye_color",
                "location",
                "availability",
                "contact",
                "prices",
                "implants",
                "uber",
                "cosmetic_surgeries",
                "other_attributes",
            ];

	            const priceSlotKeys = ["one_hour", "two_hours", "three_hours", "overnight"];
	            function renderPriceSlots(slotObj) {
	                const rows = priceSlotKeys.map(key => {
	                    const value = slotObj?.[key] ?? null;
	                    return `<tr><td>${escapeHtml(priceSlotLabel(key))}</td><td>${escapeHtml(formatFieldValue(value))}</td></tr>`;
	                }).join("");
	                return `<table class="price-table kv-table" style="font-size:12px;"><tbody>${rows}</tbody></table>`;
	            }

            function renderOtherAttributes(obj) {
                if (!obj || typeof obj !== "object" || Array.isArray(obj)) return escapeHtml(formatFieldValue(obj));
                const entries = Object.entries(obj).filter(([k, v]) => {
                    if (!k) return false;
                    if (v === null || v === undefined) return false;
                    const txt = typeof v === "string" ? v.trim() : String(v).trim();
                    return txt.length > 0;
                });
                if (!entries.length) return "—";
	                const rows = entries
	                    .sort(([a], [b]) => a.localeCompare(b, undefined, { sensitivity: "base" }))
	                    .map(([k, v]) => {
	                        const label = k.replace(/_/g, " ");
	                        const formatted = formatFieldValue(v);
	                        const safe = escapeHtml(formatted);
	                        const isObj = typeof v === "object" && v !== null;
	                        const valueHtml = isObj ? `<pre style="margin:0; white-space:pre-wrap;">${safe}</pre>` : safe;
	                        return `<tr><td>${escapeHtml(label)}</td><td>${valueHtml}</td></tr>`;
	                    })
	                    .join("");
	                return `<table class="price-table kv-table" style="font-size:12px;"><tbody>${rows}</tbody></table>`;
	            }

	            const rows = orderedKeys.map(key => {
	                const label = fieldLabel(key);
	                if (key === "prices") {
	                    return `<div class="lb-attr"><span class="k">${escapeHtml(label)}</span><span class="v">${renderPriceSlots(prices)}</span></div>`;
	                }
	                if (key === "other_attributes") {
	                    const value = ex?.[key] ?? null;
	                    return `<div class="lb-attr"><span class="k">${escapeHtml(label)}</span><span class="v">${renderOtherAttributes(value)}</span></div>`;
	                }
	                const value = ex?.[key] ?? null;
	                const formatted = formatFieldValue(value);
	                const safeFormatted = escapeHtml(formatted);
	                const isObject = typeof value === "object" && value !== null;
	                return `<div class="lb-attr"><span class="k">${escapeHtml(label)}</span><span class="v">${isObject ? `<pre style="margin:0; white-space:pre-wrap;">${safeFormatted}</pre>` : safeFormatted}</span></div>`;
	            }).join("");

	            return `<div class="lb-section"><h3>${escapeHtml(t("section_extraction"))}</h3><div class="lb-attr-grid">${rows}</div></div>`;
	        }

        function mergeContact(target, incoming) {
            if (!incoming) return;
            const source = typeof incoming === 'string' ? parseContactString(incoming) : incoming;
            if (!source || typeof source !== 'object') return;
            Object.entries(source).forEach(([key, val]) => {
                if (!val || target[key]) return;
                target[key] = val;
            });
        }

        function parsePriceInfo(value) {
            if (value == null) return null;
            if (typeof value === 'number') return { amount: value, currency: null, display: null };
            if (typeof value === 'object' && ('amount' in value || 'display' in value)) {
                const amount = typeof value.amount === 'number' ? value.amount : parseAmountFromString(value.amount ?? value.display);
                return {
                    amount: amount ?? null,
                    currency: value.currency || null,
                    display: value.display || (typeof value.amount === 'string' ? value.amount : null),
                };
            }
            if (typeof value === 'string') {
                return {
                    amount: parseAmountFromString(value),
                    currency: detectCurrencyFromString(value),
                    display: value.trim(),
                };
            }
            return null;
        }

        function detectCurrencyFromString(text = '') {
            const lower = text.toLowerCase();
            if (text.includes('₡') || lower.includes('crc') || lower.includes('colón') || lower.includes('colones')) return 'CRC';
            if (text.includes('$') || lower.includes('usd') || lower.includes('dolar') || lower.includes('dólar')) return 'USD';
            if (text.includes('€') || lower.includes('eur') || lower.includes('euro')) return 'EUR';
            return null;
        }

        function parseAmountFromString(value) {
            if (value == null) return null;
            if (typeof value === 'number') return value;
            const text = value.toString();
            const mil = /\bmil\b/i.test(text);
            let cleaned = text.replace(/[^0-9.,-]/g, '');
            if (!cleaned) return null;
            const commaCount = (cleaned.match(/,/g) || []).length;
            const dotCount = (cleaned.match(/\./g) || []).length;
            if (commaCount && !dotCount) {
                cleaned = cleaned.replace(/\./g, '').replace(',', '.');
            } else {
                cleaned = cleaned.replace(/,/g, '');
            }
            const num = parseFloat(cleaned);
            if (!isFinite(num)) return null;
            return mil ? num * 1000 : num;
        }

	        function buildMetadataTags(metadata = {}) {
	            const tags = [];
	            Object.entries(metadata).forEach(([key, val]) => {
	                if (key.endsWith('_emoji')) return;
	                // Skip structural folder markers that aren't useful as profile labels.
	                if (key && key.toString().trim() === PROVINCIA_ROOT_FOLDER) return;
	                if (val == null) return;
	                const normalized = val.toString().trim();
	                if (!normalized) return;
	                if (normalized === PROVINCIA_ROOT_FOLDER) return;
	                if (normalized.toLowerCase() === 'true') {
	                    tags.push(key);
	                } else if (normalized.toLowerCase() === 'false') {
	                    return;
	                } else if (normalized === key) {
                    tags.push(key);
                } else {
                    tags.push(normalized);
                }
            });
            return Array.from(new Set(tags));
        }

	        function guessLocationFromMetadata(metadata = {}) {
	            for (const val of Object.values(metadata)) {
	                if (!val) continue;
	                const text = val.toString().trim();
	                if (!text || text.toLowerCase() === 'true') continue;
	                if (/perfiles/i.test(text)) continue;
	                if (/recomendacion/i.test(text)) continue;
	                if (/^\d+$/.test(text)) continue;
	                return text;
	            }
	            return '';
	        }

	        function deriveFolderFilters(item = {}) {
	            const provincias = new Set();
	            const edad = new Set();
	            let nuevosIngresos = false;
	            let sinExperiencia = false;
	            let cortesia = false;
	            let nuevasFotosVideos = false;

	            const sources = Array.isArray(item.sources) ? item.sources : [];
	            for (const src of sources) {
	                const folders = Array.isArray(src?.folders) ? src.folders : [];
	                const idx = folders.indexOf(PROVINCIA_ROOT_FOLDER);
	                if (idx !== -1 && idx + 1 < folders.length) {
	                    const provincia = folders[idx + 1];
	                    if (provincia) provincias.add(provincia);
	                }
	                for (const group of EDAD_FOLDERS) {
	                    if (folders.includes(group)) edad.add(group);
	                }
	                if (folders.includes(NUEVOS_INGRESOS_FOLDER)) nuevosIngresos = true;
	                if (folders.includes(SIN_EXPERIENCIA_FOLDER)) sinExperiencia = true;
	                if (folders.includes(CORTESIA_FOLDER)) cortesia = true;
	                if (folders.includes(NUEVAS_FOTOS_VIDEOS_FOLDER)) nuevasFotosVideos = true;
	            }

		            return {
		                provincias: Array.from(provincias),
		                edad: Array.from(edad),
		                nuevos_ingresos: nuevosIngresos,
		                sin_experiencia: sinExperiencia,
		                cortesia,
		                nuevas_fotos_videos: nuevasFotosVideos,
		            };
		        }

		        function normalizeText(text) {
		            if (text === null || text === undefined) return '';
		            return String(text)
		                .normalize('NFD')
		                .replace(/[\u0300-\u036f]/g, '')
		                .toLowerCase()
		                .replace(/[^a-z0-9]+/g, ' ')
		                .replace(/\s+/g, ' ')
		                .trim();
		        }

		        function buildSearchBlob(item = {}) {
		            const structured = item.structured_data || item.merged_structured_data || {};
		            const extraction = item.extraction || {};
		            const metadata = item.merged_metadata || item.metadata || {};
		            const sources = Array.isArray(item.sources) ? item.sources : [];
		            const rawResponses = item.raw_responses || (item.raw_response ? [item.raw_response] : []);
		            const mediaList = Array.isArray(item.media) ? item.media : (Array.isArray(item.images) ? item.images : []);

		            const parts = [];
		            parts.push(item.profile);
		            parts.push(structured.name);
		            parts.push(extraction.name);
		            parts.push(structured.location);
		            parts.push(extraction.location);
		            parts.push(structured.availability);
		            parts.push(extraction.availability);
		            parts.push(structured.raw_text);
		            parts.push(JSON.stringify(structured));
		            if (rawResponses.length) parts.push(rawResponses.join('\n'));
		            if (Array.isArray(structured.services)) parts.push(structured.services.join(' '));
		            if (structured.attributes) parts.push(JSON.stringify(structured.attributes));
		            if (structured.standard_prices) parts.push(JSON.stringify(structured.standard_prices));
		            if (structured.prices) parts.push(JSON.stringify(structured.prices));
		            if (structured.contact) parts.push(JSON.stringify(structured.contact));

		            if (extraction) parts.push(JSON.stringify(extraction));
		            if (metadata) parts.push(JSON.stringify(metadata));
		            if (Array.isArray(item.metadata_tags)) parts.push(item.metadata_tags.join(' '));

		            if (sources.length) {
		                const sourceSlim = sources.map(src => ({
		                    path: src?.path,
		                    folders: src?.folders,
		                }));
		                parts.push(JSON.stringify(sourceSlim));
		            }

		            if (mediaList.length) {
		                const basenames = mediaList.map(p => String(p).split('/').pop());
		                parts.push(JSON.stringify(basenames));
		            }

		            return normalizeText(parts.filter(Boolean).join(' '));
		        }

        function canonicalForDuration(label = '') {
            const normalized = label.toLowerCase();
            for (const def of STANDARD_DURATION_ORDER) {
                if (def.canonical.toLowerCase() === normalized) return def.canonical;
                const synonyms = DURATION_SYNONYMS[def.canonical] || [];
                if (synonyms.some(pattern => normalized.includes(pattern))) {
                    return def.canonical;
                }
            }
            return null;
        }

        function getMediaList(item = {}) {
            if (Array.isArray(item.media) && item.media.length) return item.media;
            if (Array.isArray(item.images) && item.images.length) return item.images;
            return [];
        }

        function resolveMediaPath(path = '') {
            if (!path) return '';
            if (/^(https?:)?\/\//i.test(path)) return path;
            // This UI lives in /newapp/. Media paths in the JSON are stored as
            // `media_profiles/...` relative to this folder, so do not prepend `../`.
            if (path.startsWith('newapp/')) return path.slice('newapp/'.length);
            return path;
        }

        function isVideo(path = '') {
            return /\.(mp4|mov|m4v|webm|avi|mkv)$/i.test(path);
        }

        function countMediaFiles(mediaList = []) {
            let photos = 0;
            let videos = 0;
            (mediaList || []).forEach(path => {
                if (!path) return;
                if (isVideo(path)) videos += 1;
                else photos += 1;
            });
            return { photos, videos };
        }

        function renderMediaCounter(mediaList = []) {
            const { photos, videos } = countMediaFiles(mediaList);
            if (!photos && !videos) return '';
            const iconPhoto = `<svg class="mc-icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>`;
            const iconVideo = `<svg class="mc-icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect><polygon points="23 7 16 12 23 17 23 7" fill="currentColor" stroke="none"></polygon></svg>`;
            const parts = [];
            if (photos) parts.push(`<span class="mc-item" title="${escapeHtml(t('photos'))}">${iconPhoto} ${photos}</span>`);
            if (videos) parts.push(`<span class="mc-item" title="${escapeHtml(t('videos'))}">${iconVideo} ${videos}</span>`);
            return `<div class="media-counter">${parts.join('')}</div>`;
        }

        function renderCardMedia(path) {
            if (!path) return `<div style="width:100%;height:100%;background:#f7f7f7;"></div>`;
            const resolved = resolveMediaPath(path);
            if (isVideo(path)) {
                return `<video class="main-img" src="${resolved}" muted loop playsinline></video>`;
            }
            return `<img class="main-img" src="${resolved}" loading="lazy">`;
        }

        function renderThumbMedia(path, idx) {
            const resolved = resolveMediaPath(path);
            if (isVideo(path)) {
                return `<div class="lb-thumb" onclick="switchImage(${idx})"><video src="${resolved}" muted loop playsinline></video></div>`;
            }
            return `<div class="lb-thumb" onclick="switchImage(${idx})"><img src="${resolved}" alt=""></div>`;
        }

        function renderMainMedia(path) {
            const container = document.getElementById('lb-main-media');
            if (!path) {
                container.innerHTML = '';
                return;
            }
            const resolved = resolveMediaPath(path);
            if (isVideo(path)) {
                container.innerHTML = `<video controls autoplay muted playsinline src="${resolved}"></video>`;
            } else {
                container.innerHTML = `<img src="${resolved}" alt="">`;
            }
        }

        function getPrimaryPriceValue(item) {
            const d = item.structured_data || {};
            const standardEntries = buildStandardPriceEntries(d);
            for (const entry of standardEntries) {
                if (typeof entry.amount === 'number') return entry.amount;
                const parsed = parseAmountFromString(entry.value);
                if (parsed != null) return parsed;
            }
            for (const entry of (d.prices || [])) {
                if (typeof entry.amount === 'number') return entry.amount;
                const parsed = parseAmountFromString(entry.display || entry.amount);
                if (parsed != null) return parsed;
            }
            return null;
        }

        function symbolForCurrency(code = '') {
            const upper = code.toUpperCase();
            if (upper === 'CRC' || upper === 'COLONES') return '₡';
            if (upper === 'USD' || upper === 'US' || upper === 'DOL' || upper === 'DÓLAR') return '$';
            if (upper === 'EUR') return '€';
            return code || '';
        }

        function parseContactString(text = '') {
            const result = {};
            if (!text) return result;
            const normalized = text.replace(/\s+/g, ' ').trim();
            const whatsappMatch = normalized.match(/whatsapp[:\s]*([\d+()\-\s]+)/i);
            if (whatsappMatch) {
                result.whatsapp = whatsappMatch[1].trim();
            }
            const phoneMatch = normalized.match(/(?:tel(?:éfono)?|llamar|phone)[:\s]*([\d+()\-\s]+)/i);
            if (phoneMatch) {
                const value = phoneMatch[1].trim();
                if (!result.phone) result.phone = value;
            }
            const socialMatch = normalized.match(/(?:instagram|ig|facebook|onlyfans)[:\s]*([^\s].+)/i);
            if (socialMatch) {
                result.social = socialMatch[1].trim();
            }
            if (!result.whatsapp && !result.phone && !result.social) {
                result.other = normalized;
            }
            return result;
        }

        function normalizeContact(contact) {
            if (!contact) return {};
            if (typeof contact === 'string') return parseContactString(contact);
            return contact;
        }

		        function ensureActiveFilters() {
		            const keys = ['provincia', 'edad', 'nuevos_ingresos', 'sin_experiencia', 'cortesia', 'nuevas_fotos_videos'];
		            if (!activeFilters || typeof activeFilters !== 'object') activeFilters = {};
		            keys.forEach(key => {
		                if (!(activeFilters[key] instanceof Set)) activeFilters[key] = new Set();
		            });
		        }

		        function edadLabel(folderName) {
		            const entry = EDAD_LABELS[folderName];
		            if (!entry) return folderName;
		            if (typeof entry === 'string') return entry;
		            return entry[currentLang] || entry.es || folderName;
		        }

		        function buildFilters({ preserveActive = true } = {}) {
		            filters = {
		                provincia: new Set(),
		                edad: new Set(EDAD_FOLDERS),
		            };
		            if (!preserveActive) {
		                activeFilters = {
		                    provincia: new Set(),
		                    edad: new Set(),
		                    nuevos_ingresos: new Set(),
		                    sin_experiencia: new Set(),
		                    cortesia: new Set(),
		                    nuevas_fotos_videos: new Set(),
		                };
		            } else {
		                ensureActiveFilters();
		            }

	            catalog.forEach(item => {
	                const ff = item.folder_filters || deriveFolderFilters(item);
	                (ff.provincias || []).forEach(p => filters.provincia.add(p));
	            });

				            const container = document.getElementById('filters');
				            container.innerHTML = `
				                <h2>${t('app_title')}</h2>
				                <div class="lang-switch">
				                    <label for="langSelect">${t('language_label')}</label>
				                    <select id="langSelect">
				                        <option value="es">${t('language_es')}</option>
				                        <option value="en">${t('language_en')}</option>
				                    </select>
				                </div>
				            `.trim();
				            const langSelect = container.querySelector('#langSelect');
				            if (langSelect) {
				                langSelect.value = currentLang;
				                langSelect.addEventListener('change', (e) => setLanguage(e.target.value));
				            }
			            renderFilterUI(t('filters_provincia'), filters.provincia, 'provincia', container);
			            renderFilterUI(t('filters_edad'), filters.edad, 'edad', container);
			            renderCategoryToggles(container);
			        }

		        function renderFilterUI(label, set, key, container) {
		            if (!set || set.size === 0) return;
	            const group = document.createElement('div');
	            group.className = 'filter-group';
	            const title = document.createElement('h3');
	            title.textContent = label;
	            group.appendChild(title);

	            Array.from(set)
	                .filter(Boolean)
	                .sort((a, b) => a.toString().localeCompare(b.toString(), undefined, { sensitivity: 'base' }))
	                .forEach(val => {
	                const l = document.createElement('label');
	                const input = document.createElement('input');
	                input.type = 'checkbox';
	                input.checked = activeFilters[key]?.has(val) || false;
	                input.addEventListener('change', () => {
	                    const activeSet = activeFilters[key];
	                    if (!activeSet) return;
	                    if (activeSet.has(val)) activeSet.delete(val);
	                    else activeSet.add(val);
	                    render();
	                });

		                l.appendChild(input);
			                const displayVal = (key === 'edad') ? edadLabel(val) : val;
			                l.appendChild(document.createTextNode(` ${displayVal}`));
			                group.appendChild(l);
				            });
			            (container || document.getElementById('filters')).appendChild(group);
			        }

			        function renderCategoryToggles(container) {
			            const group = document.createElement('div');
			            group.className = 'filter-group';
			            const title = document.createElement('h3');
			            title.textContent = t('filters_categories');
			            group.appendChild(title);

			            const items = [
			                { key: 'nuevos_ingresos', labelKey: 'category_new' },
			                { key: 'sin_experiencia', labelKey: 'category_noexp' },
			                { key: 'cortesia', labelKey: 'category_courtesy' },
			                { key: 'nuevas_fotos_videos', labelKey: 'category_newmedia' },
			            ];

			            items.forEach(({ key, labelKey }) => {
			                if (!activeFilters[key]) activeFilters[key] = new Set();
			                const label = t(labelKey);
			                const l = document.createElement('label');
			                const input = document.createElement('input');
			                input.type = 'checkbox';
			                input.checked = (activeFilters[key] && activeFilters[key].size > 0) || false;
			                input.addEventListener('change', () => {
			                    const set = activeFilters[key];
			                    if (!set) return;
			                    set.clear();
			                    if (input.checked) set.add('1');
			                    render();
			                });
			                l.appendChild(input);
			                l.appendChild(document.createTextNode(` ${label}`));
			                group.appendChild(l);
			            });

		            (container || document.getElementById('filters')).appendChild(group);
		        }

	        const DURATION_SYNONYMS = {
	            "1 hora": ["1 hora", "1hr", "1 hr", "1h", "una hora"],
            "2 horas": ["2 horas", "2hr", "2 hrs", "2h", "dos horas"],
            "3 horas": ["3 horas", "3hr", "3 hrs", "3h", "tres horas"],
            "Toda la noche": [
                "toda la noche",
                "noche completa",
                "overnight",
                "9:00 pm a 7:00 am",
                "9 pm a 7 am",
                "9pm a 7am",
                "7 pm a 8 am",
                "9 pm a 6 am"
            ],
        };

        const STANDARD_DURATION_ORDER = [
            { key: "one_hour", label: "1 hora", short: "1h", canonical: "1 hora" },
            { key: "two_hours", label: "2 horas", short: "2h", canonical: "2 horas" },
            { key: "three_hours", label: "3 horas", short: "3h", canonical: "3 horas" },
            { key: "overnight", label: "Toda la noche", short: "Noche", canonical: "Toda la noche" },
        ];

        function normalizeDurationLabel(label) {
            if (!label) return "";
            const normalized = label.toString().toLowerCase().replace(/\s+/g, " ");
            for (const [canonical, patterns] of Object.entries(DURATION_SYNONYMS)) {
                if (patterns.some(pattern => normalized.includes(pattern))) {
                    return canonical;
                }
            }
            return "";
        }

        function inferCurrency(prices) {
            if (!Array.isArray(prices) || prices.length === 0) return null;
            for (const item of prices) {
                if (item && typeof item === "object") {
                    if (item.currency) return item.currency;
                    if (item.display) {
                        const currency = detectCurrencyFromString(item.display);
                        if (currency) return currency;
                    }
                }
            }
            return null;
        }

        function formatVal(p = {}) {
            if (!p) return "";
            if (p.display) return p.display;
            let amount = p.amount;
            if (typeof amount === 'string') {
                amount = parseAmountFromString(amount);
            }
            const symbol = symbolForCurrency(p.currency || '');
            if (typeof amount === 'number' && isFinite(amount)) {
                return `${symbol}${amount.toLocaleString()}`.trim();
            }
            if (amount != null) {
                return `${symbol}${amount}`;
            }
            return symbol || '';
        }

        function formatAmount(amount, currency) {
            return formatVal({ amount, currency });
        }

        function buildStandardPriceEntries(profile) {
            const prices = profile.prices || [];
            const standard = profile.standard_prices || {};
            const fallbackCurrency = inferCurrency(prices) || 'CRC';

	            return STANDARD_DURATION_ORDER.map(def => {
	                const raw = standard[def.key];
	                if (raw == null) return null;
	                const normalized = normalizeStandardValue(raw, fallbackCurrency);
	                if (!normalized) return null;
	                const amountVal = normalized.amount ?? parseAmountFromString(normalized.display);
	                return {
	                    label: priceSlotLabel(def.key),
	                    short: priceSlotShort(def.key),
	                    value: normalized.display || '',
	                    amount: amountVal ?? null,
	                    currency: normalized.currency || fallbackCurrency,
	                };
	            }).filter(entry => entry && entry.value);
	        }

        function buildStandardSummary(profile) {
            const entries = buildStandardPriceEntries(profile);
            if (!entries.length) return "";
            return entries.map(entry => `${entry.short} ${entry.value}`).join(' · ');
        }

        function normalizeStandardValue(raw, fallbackCurrency) {
            if (raw == null) return null;
            if (typeof raw === 'object' && ('amount' in raw || 'display' in raw)) {
                const amount = typeof raw.amount === 'number' ? raw.amount : parseAmountFromString(raw.amount ?? raw.display);
                const currency = raw.currency || fallbackCurrency || detectCurrencyFromString(raw.display || '');
                const display = raw.display || (amount != null ? formatAmount(amount, currency) : null);
                return { amount, currency, display };
            }
            if (typeof raw === 'number') {
                return { amount: raw, currency: fallbackCurrency, display: formatAmount(raw, fallbackCurrency) };
            }
            if (typeof raw === 'string') {
                const info = parsePriceInfo(raw) || {};
                const amount = info.amount;
                const currency = info.currency || fallbackCurrency;
                const display = info.display || raw;
                return {
                    amount,
                    currency,
                    display: amount != null ? formatAmount(amount, currency) : display,
                };
            }
            return null;
        }

        function formatRawText(text, prices) {
            if (!text) return "";
            let cleaned = text.replace(RAW_TEXT_DISCLAIMER_PATTERN, "").trim();
            if (!prices || prices.length === 0) return cleaned;
            const hasCRC = prices.some(p => {
                const currency = (p?.currency || detectCurrencyFromString(p?.display || '') || '').toUpperCase();
                return currency === 'CRC';
            });
            if (hasCRC) {
                cleaned = cleaned.replace(/\$(\d)/g, '₡$1');
            }
            return cleaned;
        }

        const RAW_TEXT_DISCLAIMER_PATTERN = /INFORMACIÓN EMANADA[\s\S]*?proporcionarle el contacto\./gi;

        let filteredItems_ = []; // Store references for index access
	        let currentItemIndex = -1;
	        let currentImageIndex = 0;

	        function render() {
	            const queryRaw = document.getElementById('searchInput').value || '';
	            const q = normalizeText(queryRaw);
	            const qTokens = q ? q.split(' ').filter(Boolean) : [];
	            const sort = document.getElementById('sortSelect').value;

		            let filtered = catalog.filter(item => {
		                const d = getDisplayData(item);
		                const ff = item.folder_filters || {};
		                const haystack = item.search_blob || normalizeText(JSON.stringify(item));
		                if (qTokens.length && !qTokens.every(token => haystack.includes(token))) return false;
		                if (activeFilters.provincia.size) {
		                    const provincias = Array.isArray(ff.provincias) ? ff.provincias : [];
		                    if (!provincias.some(p => activeFilters.provincia.has(p))) return false;
		                }
	                if (activeFilters.edad.size) {
	                    const edadGroups = Array.isArray(ff.edad) ? ff.edad : [];
	                    if (!edadGroups.some(g => activeFilters.edad.has(g))) return false;
	                }
	                const categorySpecs = [
	                    { key: 'nuevos_ingresos', match: !!ff.nuevos_ingresos },
	                    { key: 'sin_experiencia', match: !!ff.sin_experiencia },
	                    { key: 'cortesia', match: !!ff.cortesia },
	                    { key: 'nuevas_fotos_videos', match: !!ff.nuevas_fotos_videos },
	                ];
	                const anyCategorySelected = categorySpecs.some(spec => activeFilters[spec.key]?.size);
	                if (anyCategorySelected) {
	                    const matchesAny = categorySpecs.some(spec => activeFilters[spec.key]?.size && spec.match);
	                    if (!matchesAny) return false;
	                }
	                return true;
	            });

            // Sort
            if (sort === 'price_asc') filtered.sort((a, b) => (getPrimaryPriceValue(a) ?? Infinity) - (getPrimaryPriceValue(b) ?? Infinity));
            if (sort === 'price_desc') filtered.sort((a, b) => (getPrimaryPriceValue(b) ?? -Infinity) - (getPrimaryPriceValue(a) ?? -Infinity));

            filteredItems_ = filtered;
            document.getElementById('stats').innerText = t('stats_found', filtered.length);

	            document.getElementById('grid').innerHTML = filtered.map((item, idx) => {
	                const d = getDisplayData(item);
	                const mediaList = getMediaList(item);
	                const previewMedia = mediaList[0];
	                const name = d.name || item.profile || t('unknown');
	                const loc = d.location || '';
	                const ageText = (d.age !== null && d.age !== undefined && d.age !== '') ? t('years_short', d.age) : '';
	                const stdSummary = buildStandardSummary(d);
	                const prices = stdSummary || (d.prices || []).map(formatVal).filter(Boolean).join(' · ');
                const metaTags = (item.metadata_tags || []).slice(0, 2);
                const serviceTags = (d.services || []).slice(0, 2);
                const tags = [...metaTags, ...serviceTags].slice(0, 4).map(tag => `<span class="pill">${tag}</span>`).join('');

                return `
                <div class="card" onclick="openProfile(${idx})">
                    <div class="card-img-container">
                        ${renderCardMedia(previewMedia)}
                        ${renderMediaCounter(mediaList)}
	                    </div>
	                    <div class="card-details">
	                        <div class="name">${name}</div>
	                        ${ageText ? `<div class="age">${ageText}</div>` : ''}
	                        ${loc ? `<div class="location">${loc}</div>` : ''}
	                        ${prices ? `<div class="price">${prices}</div>` : ''}
	                        <div class="tags">${tags}</div>
	                    </div>
                </div>`;
            }).join('');
        }

	        window.openProfile = (idx) => {
	            const item = filteredItems_[idx];
	            if (!item) return;
	            const d = getDisplayData(item);
	            const extraction = item.extraction || {};
	            const mediaList = getMediaList(item);
	            const thumbs = document.getElementById('lb-thumbs');
                const navLeft = document.getElementById('lb-nav-left');
                const navRight = document.getElementById('lb-nav-right');
                const showNav = mediaList.length > 1;
	            thumbs.innerHTML = mediaList.length > 1 ? mediaList.map((src, imageIdx) =>
	                renderThumbMedia(src, imageIdx)
	            ).join('') : '';
                if (navLeft) navLeft.style.display = showNav ? 'flex' : 'none';
                if (navRight) navRight.style.display = showNav ? 'flex' : 'none';
	            currentItemIndex = idx;
	            currentImageIndex = 0;
	            updateLightboxImage();

            const name = d.name || item.profile || t('unknown');
	            const age = d.age ? t('years_old', d.age) : '';
            const loc = d.location || '';
            const subtitleParts = [];
            if (loc) subtitleParts.push(loc);
            if (age) subtitleParts.push(age);
            const subtitle = subtitleParts.join(' • ');

	            let html = `
	                <div class="lb-header">
	                    <h1>${escapeHtml(name)}</h1>
	                    ${subtitle ? `<p>${escapeHtml(subtitle)}</p>` : ''}
	                </div>
	            `;

            html += renderExtractionSection(item.extraction);

            // Attributes
            const attrOrder = ['height', 'weight', 'measurements', 'hair_color', 'eye_color', 'implants', 'uber', 'cosmetic_surgeries'];
            const attrEntries = [];
            const attrs = d.attributes || {};
            attrOrder.forEach(key => {
                if (attrs[key] != null && attrs[key] !== '') {
                    // Avoid repeating fields already shown in the extraction block.
                    if (extraction[key] !== undefined && extraction[key] !== null && extraction[key] !== '') return;
                    attrEntries.push([key, attrs[key]]);
                }
            });
            Object.entries(attrs).forEach(([key, value]) => {
                if (attrOrder.includes(key)) return;
                if (value == null || value === '') return;
                attrEntries.push([key, value]);
            });
	            if (attrEntries.length) {
	                const attrHtml = attrEntries.map(([k, rawV]) => {
	                    const label = fieldLabel(k);
	                    const formatted = formatFieldValue(rawV);
	                    return `<div class="lb-attr"><span class="k">${escapeHtml(label)}</span><span class="v">${escapeHtml(formatted)}</span></div>`;
	                }).join('');
	                html += `<div class="lb-section"><h3>${escapeHtml(t('section_attributes'))}</h3><div class="lb-attr-grid">${attrHtml}</div></div>`;
	            }

            const standardEntries = buildStandardPriceEntries(d);
            const extraPrices = (d.prices || []).filter(p => {
                const canonical = p?.canonical || canonicalForDuration(p?.duration || '');
                return !canonical || !STANDARD_DURATION_ORDER.some(def => def.canonical === canonical);
            });

            if (standardEntries.length || extraPrices.length) {
	                let tableRows = '';

	                standardEntries.forEach(entry => {
	                    tableRows += `<tr><td>${escapeHtml(entry.label)}</td><td>${escapeHtml(entry.value)}</td></tr>`;
	                });

	                extraPrices.forEach(p => {
	                    tableRows += `<tr><td>${escapeHtml(p.duration || t('table_service'))}</td><td>${escapeHtml(formatVal(p))}</td></tr>`;
	                });

	                html += `
	                    <div class="lb-section">
	                        <h3>${escapeHtml(t('section_rates'))}</h3>
	                        <table class="price-table">
	                            <thead>
	                                <tr><th>${escapeHtml(t('table_service'))}</th><th>${escapeHtml(t('table_amount'))}</th></tr>
	                            </thead>
	                            <tbody>
	                                ${tableRows}
	                            </tbody>
	                        </table>
	                    </div>`;
	            }

	            // Services
	            if (d.services?.length) {
	                html += `<div class="lb-section"><h3>${escapeHtml(t('section_services'))}</h3>
	                <div style="display:flex; flex-wrap:wrap; gap:6px;">
	                    ${d.services.map(s => `<span class="pill" style="font-size:12px; padding:6px 10px;">${s}</span>`).join('')}
	                </div></div>`;
	            }

	            // Bio - Apply currency formatting
	            if (d.availability) {
	                html += `<div class="lb-section"><h3>${escapeHtml(t('section_availability'))}</h3><p style="font-size:14px; color:#555;">${escapeHtml(d.availability)}</p></div>`;
	            }

	            if (item.metadata_tags?.length) {
	                html += `<div class="lb-section"><h3>${escapeHtml(t('section_tags'))}</h3>
	                    <div style="display:flex; flex-wrap:wrap; gap:6px;">
	                        ${item.metadata_tags.map(tag => `<span class="pill" style="font-size:12px; padding:6px 10px;">${tag}</span>`).join('')}
	                    </div>
	                </div>`;
	            }

	            // Contact
	            const contact = normalizeContact(d.contact);
	            const contactRows = [];
	            if (contact.whatsapp) contactRows.push(`<div><strong>${escapeHtml(t('label_whatsapp'))}:</strong> ${escapeHtml(contact.whatsapp)}</div>`);
	            if (contact.phone) contactRows.push(`<div><strong>${escapeHtml(t('label_phone'))}:</strong> ${escapeHtml(contact.phone)}</div>`);
	            if (contact.email) contactRows.push(`<div><strong>${escapeHtml(t('label_email'))}:</strong> ${escapeHtml(contact.email)}</div>`);
	            if (contact.social) contactRows.push(`<div><strong>${escapeHtml(t('label_social'))}:</strong> ${escapeHtml(contact.social)}</div>`);
	            if (contact.other) contactRows.push(`<div><strong>${escapeHtml(t('label_contact'))}:</strong> ${escapeHtml(contact.other)}</div>`);

	            if (contactRows.length) {
	                html += `<div class="lb-section"><h3>${escapeHtml(t('section_contact'))}</h3>${contactRows.join("")}</div>`;
	            }
            if (contact.whatsapp) {
                const waNumber = contact.whatsapp.replace(/\D/g, '');
                if (waNumber) {
                    html += `<a href="https://wa.me/${waNumber}" target="_blank" class="cta-btn">WhatsApp ${contact.whatsapp}</a>`;
                }
            }
		            if (contact.phone) {
		                html += `<a href="tel:${contact.phone.replace(/[^+\d]/g, '')}" style="display:block; text-align:center; margin-top:10px; color:#555; text-decoration:underline;">${escapeHtml(t('call'))} ${escapeHtml(contact.phone)}</a>`;
		            }

            document.getElementById('lb-details-content').innerHTML = html;
            document.getElementById('lightbox').classList.add('active');
        };

        window.closeProfile = () => {
            document.getElementById('lightbox').classList.remove('active');
        };

        function updateLightboxImage() {
            const container = document.getElementById('lb-main-media');
            if (currentItemIndex < 0) {
                container.innerHTML = '';
                return;
            }
            const item = filteredItems_[currentItemIndex];
            const mediaList = getMediaList(item);
            if (!mediaList.length) {
                container.innerHTML = '';
                document.getElementById('lb-thumbs').innerHTML = '';
                return;
            }
            const total = mediaList.length;
            currentImageIndex = (currentImageIndex + total) % total;
            renderMainMedia(mediaList[currentImageIndex]);
            let activeEl = null;
            document.querySelectorAll('#lb-thumbs .lb-thumb').forEach((el, idx) => {
                const isActive = idx === currentImageIndex;
                el.classList.toggle('active', isActive);
                if (isActive) activeEl = el;
            });
            if (activeEl) {
                activeEl.scrollIntoView({ block: 'nearest', inline: 'center' });
            }
        }

        window.switchImage = (idx) => {
            currentImageIndex = idx;
            updateLightboxImage();
        };

        function cycleImage(delta) {
            const lightbox = document.getElementById('lightbox');
            if (!lightbox.classList.contains('active')) return;
            const item = filteredItems_[currentItemIndex];
            const mediaList = getMediaList(item);
            if (!item || !(mediaList && mediaList.length > 1)) return;
            currentImageIndex += delta;
            updateLightboxImage();
        }

		        document.addEventListener('keydown', e => {
		            const authActive = document.getElementById('auth-overlay')?.classList.contains('active');
		            if (authActive) return;
		            const disclaimerActive = document.getElementById('disclaimer-overlay')?.classList.contains('active');
		            if (e.key === "Escape") {
		                if (disclaimerActive) {
		                    hideDisclaimer(true);
		                    return;
		                }
		                closeProfile();
		            }
		            if (disclaimerActive) return;
		            if (e.key === "ArrowRight") {
		                e.preventDefault();
		                cycleImage(1);
		            } else if (e.key === "ArrowLeft") {
		                e.preventDefault();
		                cycleImage(-1);
		            }
		        });

            // Disclaimer controls
            document.getElementById("disclaimer-overlay")?.addEventListener("click", () => hideDisclaimer(true));
	            document.getElementById("disclaimer-close")?.addEventListener("click", () => hideDisclaimer(true));
	            document.getElementById("disclaimer-later")?.addEventListener("click", () => hideDisclaimer(true));
	            document.getElementById("disclaimer-accept")?.addEventListener("click", () => hideDisclaimer(true));

	            applyStaticTranslations();
	            setupAuth();
	            if (!showAuthIfNeeded()) {
	                startAppOnce();
	            }
		    </script>
	</body>

</html>
